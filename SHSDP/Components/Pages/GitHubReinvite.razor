@page "/GitHubReinvite"
@rendermode InteractiveServer
@inherits PageBase
<PageTitle>SH SDP/IT | GitHub Re-Invite</PageTitle>

<main class="container border p-3">
    <h3>GitHub Re-Invite</h3>
    <hr />
    <p>
        Occasionally, some students encounter a <strong>"Repository Access Issue"</strong> error
        or cannot access the repository
        for a GitHub Classroom assignment, even though they have accepted the invitation.
        The fix is to temporarily remove you from the repository and then re-invite you.
        This page automates that process.
    </p>

    <h5>How it works</h5>
    <ul>
        <li>You will sign in with your GitHub account so the system can confirm your username.</li>
        <li>You will select the <strong>classroom</strong> where you are having trouble.</li>
        <li>You will choose the <strong>assignment</strong> that is affected.</li>
        <li>The system will <strong>remove and then re-invite</strong> you to the assignment repository with write access.</li>
    </ul>

    <div class="alert alert-warning mt-3" role="alert">
        <strong>Important:</strong> The invitation email is sent to the <em>email address on your GitHub account</em>
        (the one you used when creating your GitHub account), not necessarily your school email.
        Check that inbox (and spam/junk). You can also accept directly on GitHub under
        <em>Notifications</em>.
    </div>


    <p class="mt-3">
        Use this tool only if you cannot see or access your repository for an assignment. If everything is working normally,
        you do not need to run this process.
    </p>
    
    @if (IsAuthenticated == false)
    {
        <p>To begin, sign in with your GitHub account so we can confirm your username.</p>
        <button class="btn btn-primary" @onclick="SignInWithGitHub">
            <i class="bi bi-github" aria-hidden="true"></i>
            Sign in with GitHub
        </button>
    }
    else
    {
        <div class="alert alert-success">
            Signed in as <strong>@GitHubLogin</strong>
        </div>
        <button class="btn btn-secondary" @onclick="SwitchUser">
            Switch GitHub Account
        </button>
        
        <hr />
        
        @if (IsLoadingClassrooms)
        {
            <h5>Loading classrooms...</h5>
            
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        }
        else if (Classrooms.Count == 0)
        {
            <div class="alert alert-warning mt-3" role="alert">
                No classrooms found. If you believe this is an error, please contact your instructor.
            </div>
        }
        else
        {
            <h5>Select a classroom</h5>
            
            <select class="form-select" id="classroomDropdown" @bind="SelectedClassroomId">
                <option disabled selected value>-- Choose a Classroom --</option>
                @foreach (GHClassroom classroom in Classrooms)
                {
                    <option value="@classroom.Id">@classroom.Name</option>
                }
            </select>
        }
    }
    
    @if (SelectedClassroomId != null)
    {
        <div class="my-3">
            @if (IsLoadingAssignments)
            {
                <h5>Loading assignments...</h5>
            
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            }
            else if (Assignments.Count == 0)
            {
                <div class="form-control disabled bg-light">
                    No assignments found for this classroom.
                </div>
            }
            else
            {
                <h5>Select an assignment</h5>
                
                <select class="form-select" id="assignmentDropdown" @bind="SelectedAssignmentId">
                    <option disabled selected value>-- Choose an Assignment --</option>
                    @foreach (GHAssignment assignment in Assignments)
                    {
                        <option value="@assignment.Id">@assignment.Title</option>
                    }
                </select>
            }
        </div>
    }
    
    @if (SelectedAssignmentId != null)
    {
        <div class="mt-4">
            <button class="btn btn-danger" @onclick="FixAccessAsync" disabled="@IsFixingRepo">
                @if (IsFixingRepo)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span>Fixing Access...</span>
                }
                else
                {
                    <i class="bi bi-wrench"></i> <span>Fix Repository Access</span>
                }
            </button>

            @if (String.IsNullOrEmpty(ActionMessage) == false)
            {
                String alertClass = WasFixSuccessful ? "alert-success" : "alert-danger";
                
                <div class="alert @alertClass mt-3" @onclick:stopPropagation="true">
                    @((MarkupString)ActionMessage)
                </div>
            }
        </div>
    }

</main>

